<p id="notice"><%= notice %></p>
<% suite = @test.suite %>

<div style="display: none;" id="page_info" data-test="<%= @test.id %>"></div>

<% if @test.session_expired_at and
    @test.session_expired_at.to_formatted_s(:number) > Time.now.to_formatted_s(:number) %>
    <button id="stopRecording" class="btn btn-danger">Stop recording steps</button>
<% else %>
    <button id="startRecording" class="btn-primary btn">Recording Steps</button>
    <% if @test.running %>
        <button id="showRunningTest" type="button" class="btn btn-danger" disabled>
          <span class="glyphicon glyphicon-repeat normal-left-spinner"></span>
          Test Running
        </button>
    <% else %>
        <% if @test.steps.count > 0 %>
          <button id="runTest" class="btn-primary btn">Run Test</button>
        <% end %>
    <% end %>

    <button id="addNewStep" class="btn-primary btn">Add Step</button>
<% end %>

<h4 style="display: block; width:300px; margin: 0 auto;">Test: <%= @test.title %>
  <%= render "tests/delete_btn", test: @test %> -
  <%= render "tests/edit_btn", test: @test %>
</h4>

<p>
  <strong>Suite:</strong>
  <%= link_to suite.title, controller: "suites", action: "show", id: suite.name %>
  <span class="glyphicon glyphicon-edit"></span>
</p>

<p>
  <strong>Lastest Run:</strong>
  <% if @result.present? %>
      <% count = @test.results.where.not(assertion: Assertion.find_by(assertion_type: 'report')).where(runId: @result.runId).count %>
      <a href="<%= @result.url %>"><%= time_ago_in_words @result.created_at %></a>
      (<%= pluralize(count, ' failed assertion') %>)
  <% else %>
      never ran before
  <% end %>
</p>

<% if @test.description.present? %>
    <p>
      <strong>Description:</strong>
      <%= @test.description %>
    </p>
<% end %>

<div id="validation_err"></div>

<% if suite.pre_tests.count > 0 %>
    <div>To run before the test:
      <% suite.pre_tests.each do |test| %>
          <a class="hash-pair" href="<%= test.url %>"><%= test.title %></a>
      <% end %>
    </div>
<% end %>


<div class="container-fluid">
  <div class="row">
    <div class="col-sm-5">
      <div><br> Define your test parameters<br>
        <div id="test_params"><%= render "tests/test_params" %></div>

        <a id="add-test-params" class="pointer"> Add New Test Params</a>
        
      </div>

      <div><br> Assertions:
        <a id="add-assertion" class="pointer"> Add Assertion</a><br>

        <div id="assertion-list">
          <% @test.assertions.each do |assertion| %>
              <%= render "assertions/show_assertion", assertion: assertion %>
          <% end %>
          <label><input class="default-assertion" type="checkbox" checked disabled>
              All tabs return 200 status</label> <br>
          <label><input class="default-assertion" type="checkbox" checked disabled>
              All ajax requests return 200 status</label>
        </div>
      </div>
    </div>

    <div class="col-sm-7">
      <div id="step-list">
        <% if @test.steps.count > 0 %>
            <% sumTime = 0 %>
            <h5>The test takes <%= @test.steps.inject(0){|sum,step| sum + step.wait} %> milliseconds</h5>

            <% @test.steps.order('steps.order').each_with_index do |step, index| %>
                <%= render "step/show", step: step , index: index %>
            <% end %>
        <% else %>
            <p>Once your test recording session is finished, its steps will be listed here.</p>
        <% end %>
      </div>
    </div>

  </div>
</div>
